!function(f){f.su.moduleManager.define("offlineDownload",{deps:[],services:["ajax","vtype"],models:["offlineEnableModel","offlineSettingModel","allocationModel","downloadTaskModel"],stores:["usbVolumStore","treeStore","downloadTaskStore","sourceStore","downloadTaskTreeStore"],views:["offlineDownloadView"],listeners:{ev_on_launch:function(e,t,o,a,n,l,i){this.unRegisterAutoSaveData([a.offlineEnableModel,a.downloadTaskModel,n.treeStore,n.downloadTaskTreeStore]),t.loadOfflineSetting(),t.startCheckUsb(),t.filterTaskField()},ev_before_destroy:function(e,t,o,a,n,l,i){t.stopTestAmule(),t.stopRefreshTask(),t.stopCheckUsb()}},init:function(a,o,n,i,e,s){this.configViews({id:"offlineDownloadView",items:[{id:"grid-offline-download",operation:["add",{renderer:function(){var e="";return e+'<a href="javascript:void(0);" tbar-name="clean" class="operation-btn btn-clean">'+'<span class="icon"></span>'+('<span class="text">'+f.su.CHAR.OFFLINE_DOWNLOAD.CLEAN+"</span>")+"</a>"}}],configs:{popEditor:{addTitle:f.su.CHAR.OFFLINE_DOWNLOAD.ADD_DOWNLOAD_TASK,content:"#grid-offline-download-editor",fields:[{name:"type"},{name:"url"},{name:"btFileVolumn",mapping:"bt_file_volumn"},{name:"btFile",mapping:"bt_file"}]},columns:[{text:f.su.CHAR.OFFLINE_DOWNLOAD.FILE,dataIndex:"file",renderer:function(e,t){return e=e.replace(/%/g,"%25"),decodeURI(e)}},{text:f.su.CHAR.OFFLINE_DOWNLOAD.SPEED,dataIndex:"downloadSpeed",width:110,cls:"center-td",renderer:function(e,t){return 0==e||"---"==e||"active"!=t.status?"---":'<div class="speed-upload-container widget-container"><span class="icon"></span>'+'<span class="text">'+a.calculateSpeed(t.uploadSpeed)+'</span></div><div class="speed-download-container widget-container"><span class="icon"></span>'+'<span class="text">'+a.calculateSpeed(e)+"</span></div>"}},{text:f.su.CHAR.OFFLINE_DOWNLOAD.PROGRESS,dataIndex:"completed",width:140,cls:"center-td",xtype:"customWidget",widgetName:"progressbar",settings:{showPercentage:!1},renderer:function(e,t){var o,a,n,l="";return parseInt(t.size)?(o="---"==e?0:Math.floor(e/t.size*100),a=f.su.numToCapacityAccurate(t.size,1)||t.size,n=f.su.numToCapacityAccurate(e,1)||e):o=a=n=0,[o,l+=n+"/"+a]}},{text:f.su.CHAR.OFFLINE_DOWNLOAD.REMAINTING,dataIndex:"downloadSpeed",cls:"center-td",width:90,renderer:function(e,t){return 0==e||"---"==e||"active"!=t.status?"---":(t=8*(t.size-t.completed)/e,(e=[])[0]=Math.floor(t/60/60),e[1]=Math.floor((t-60*e[0]*60)/60),e[2]=Math.floor((t-60*e[0]*60-60*e[1])%60),f.each(e,function(e,t){return t<10?"0"+t:t}),e.join(":"))}},{text:f.su.CHAR.OFFLINE_DOWNLOAD.CONNECTED_PEERS,dataIndex:"numSeeders",cls:"center-td",renderer:function(e,t){return"---"!=e&&t.connections&&0!=t.connections&&"complete"!=t.status?e+"/"+t.connections:"---"}},{text:f.su.CHAR.OFFLINE_DOWNLOAD.STATUS,dataIndex:"status",cls:"center-td",renderer:function(e,t){var o="";return o+('<a href="javascript:void(0);" class="grid-content-btn grid-content-btn-status btn-status-'+e+'">')+'<span class="icon"></span>'+'<span class="text"></span>'+"</a>"}},{text:f.su.CHAR.OFFLINE_DOWNLOAD.MODIFY,dataIndex:"status",width:60,cls:"center-td",xtype:"actioncolumn",renderer:function(e,t){var o,a="",e="paused"==e?(o="off","resume"):(o="on","pause");return a+'<a href="javascript:void(0)" '+('class="grid-content-btn grid-content-btn-internet-access btn-internet-access btn-action '+o+'" ')+('click-action="'+e+'">')+'<span class="icon"></span>'+'<span class="text"></span>'+"</a>"+'<a href="javascript:void(0)" '+'class="grid-content-btn grid-content-btn-delete btn-delete btn-action" '+'click-action="remove">'+'<span class="icon"></span>'+'<span class="text"></span>'+"</a>"}}]}}]}),this.listen({"models.offlineEnableModel":{ev_loaded:function(e,t){"on"!=t.enable||a.hasUsbError()?a.disableHandler():a.enableHandler(),"off"==t.enable&&a.stopTestAmule()}},"models.offlineSettingModel":{ev_loaded:function(){a.setSpeedLimit(),a.startTestAmule()}},"models.offlineSettingModel.scheduleEnable":{ev_value_change:function(e,t){"on"==t?n.offlineSettingModel.scheduleEnable.showActionIcon():n.offlineSettingModel.scheduleEnable.hideActionIcon()}},"models.offlineSettingModel.btMaxOpenFiles":{ev_value_change:a.setPeersLimit},"models.offlineSettingModel.amuleServer":{ev_value_change:a.stopTestAmule},"models.offlineSettingModel.amulePort":{ev_value_change:a.stopTestAmule},"models.allocationModel":{ev_will_auto_save:function(e,t){t.preventDefault()}},"models.allocationModel.uuid":{ev_value_change:function(e,t){t?a.renderFloderTree("treeStore",t,function(){o.offlineDownloadView.allocationModelTreePath.show()}):o.offlineDownloadView.allocationModelTreePath.hide()}},"models.downloadTaskModel.type":{ev_value_change:a.filterTaskField},"models.downloadTaskModel.btFileVolumn":{ev_value_change:function(e,t){t?a.renderFloderTree("downloadTaskTreeStore",t,function(){o.offlineDownloadView.downloadTaskTreePath.show()}):o.offlineDownloadView.downloadTaskTreePath.hide()}},"views.offlineDownloadView.downloadTaskTreePath":{ev_value_change:function(e,t){t&&0!=t.length&&(t=JSON.parse(t)[0],n.downloadTaskModel.btFileUSB.setValue(t),a.checkFileName(t,"torrent"))}},"views.offlineDownloadView.allocationModelTreePath":{ev_value_change:function(e,t,o){o&&(o="string"==typeof t?JSON.parse(t):t,t=n.allocationModel.path.getValue(),o[0]!=t)&&n.allocationModel.path.setValue(o[0])}}}),this.control({".index-common-save-btn":{ev_will_auto_save:function(){a.submitFolderPath(),a.submitOfflineSetting()}},"#confirm-msg":{ev_msg_ok:a.submitAllocationModel},"#offline-enable":{ev_view_change:function(e){n.offlineEnableModel.isDirty()&&n.offlineEnableModel.submit({autoReload:!0})}},"#grid-offline-download":{ev_grid_before_save:function(e,t,o){t.preventDefault(),a.validate()&&(t=a.uploadFile(),f.when(t).done(function(){a.submitTask(o)}).fail(a.uploadFailCallback))},ev_grid_before_item_delete:function(e,t){t.preventDefault()},ev_grid_edit:function(e,t){"usb"==n.downloadTaskModel.type.getValue()&&n.downloadTaskModel.btFileVolumn.getValue()&&a.renderFloderTree("downloadTaskTreeStore",n.downloadTaskModel.btFileVolumn.getValue(),function(){o.offlineDownloadView.downloadTaskTreePath.show()})}},"#grid-offline-download .btn-clean":{click:function(e){e.preventDefault();var o=[],a=[],n=[],l=[],t=i.downloadTaskStore,e=t.getData();f.each(e,function(e,t){"complete"==t.status&&(o.push(t.key),a.push(e),n.push(t.gid),l.push(t.type))}),o.length&&s.ajax.request({proxy:"downloadTaskProxy",data:{operation:"remove",key:o,index:a,gid:n,type:l},success:function(){t.load()}})}},"#grid-offline-download => a.btn-action":{ev_grid_action_click:function(e,t){var e=f(e.target).attr("click-action"),o=i.downloadTaskStore.getIndex(t),t=i.downloadTaskStore.getModelByKey(t).getData();s.ajax.request({proxy:"downloadTaskProxy",data:{operation:e,index:o,key:t.key,gid:t.gid,type:t.type},success:a.startRefreshTask})}},"#source-usb-file":{ev_before_open:function(e,t){t.preventDefault()}},".icon-schedule":{click:function(e){o.offlineDownloadView.scheduleMsg.show()}},".source-file":{ev_file_change:function(e,t){a.checkFileName(t,"torrent")}}})}},function(a,o,n,l,e,i){var s="",d="",t=[f.su.CHAR.UNIT.BIT_BPS_ABBR,f.su.CHAR.UNIT.BIT_KBPS_ABBR,f.su.CHAR.UNIT.BIT_MBPS_ABBR,f.su.CHAR.UNIT.BIT_GBPS_ABBR,f.su.CHAR.UNIT.BIT_TBPS_ABBR],r="uuid",u="path",c={ENABLE:"enalbe",DISABLE:"disable"};return{taskInterval:null,amuleInterval:null,usbStatusInterval:null,enableTimeout:null,allocationTimeout:null,setSpeedLimit:function(){var e=n.offlineSettingModel;e.maxDownload.setVtype({vtype:"number",min:1,max:e.maxDownloadLimit.getValue()}),e.maxUpload.setVtype({vtype:"number",min:1,max:e.maxUploadLimit.getValue()})},setPeersLimit:function(e,t){t=Math.min(t||200,200),n.offlineSettingModel.btMaxPeers.setVtype({vtype:"number",min:1,max:t}),n.offlineSettingModel.btMaxPeers.validate()},startRefreshTask:function(){"on"===n.offlineEnableModel.enable.getValue()&&(a.stopRefreshTask(),l.downloadTaskStore.load(),a.taskInterval=setInterval(function(){l.downloadTaskStore.load()},7e3))},stopRefreshTask:function(){clearInterval(a.taskInterval),a.taskInterval=null},startTestAmule:function(){o.offlineDownloadView.amuleStatus.setLoading(),o.offlineDownloadView.amuleStatus.show(),setTimeout(a.testAmule,2e3),a.amuleInterval=setInterval(a.testAmule,31e3)},stopTestAmule:function(e,t){clearInterval(a.amuleInterval),a.amuleInterval=null,o.offlineDownloadView.amuleStatus.setNormal(),o.offlineDownloadView.amuleStatus.hide()},testAmule:function(){var e=n.offlineSettingModel.amuleServer.getValue(),t=n.offlineSettingModel.amulePort.getValue();e&&t&&i.ajax.request({proxy:"amuleProxy",data:{operation:"status",amule_server:e,amule_port:t},success:a.setAmuleServerStatus,fail:a.setAmuleServerStatus,error:a.setAmuleServerStatus})},setAmuleServerStatus:function(e){switch(!!e&&e.status){case"connecting":o.offlineDownloadView.amuleStatus.setLoading();break;case"connected":o.offlineDownloadView.amuleStatus.setSuccess();break;default:o.offlineDownloadView.amuleStatus.setFailed()}},startCheckUsb:function(){a.checkUsbStatus(),a.usbStatusInterval=setInterval(a.checkUsbStatus,47e3)},stopCheckUsb:function(){clearInterval(a.usbStatusInterval),clearTimeout(a.enableTimeout),clearTimeout(a.allocationTimeout),a.usbStatusInterval=null},checkUsbStatus:function(){l.usbVolumStore.load({success:a.checkEnableStatus,fail:a.disableHandler,error:a.disableHandler})},checkEnableStatus:function(){a.enableTimeout=setTimeout(function(){n.offlineEnableModel.load({success:a.checkFolderStatus})},500)},checkFolderStatus:function(){a.allocationTimeout=setTimeout(a.loadAllocationModel,500)},loadAllocationModel:function(){n.allocationModel.load({success:function(e){e.path&&(e=[[e.path]],o.offlineDownloadView.allocationModelTreePath.setValue(e)),d="",a.setFolderFieldNormal(),a.enableHandler()},fail:a.usbFailCallback,error:a.usbFailCallback})},submitAllocationModel:function(){n.allocationModel.submit()},usbFailCallback:function(e,t){d=a.isUsbError(t)?r:u,a.setFolderFieldNormal(),a.disableHandler(),a.setFolderFieldError(t)},isUsbError:function(e){return"00000253"===e||"00000254"===e},isUsbUuidError:function(){return d==r},hasUsbError:function(){return!!d},setFolderFieldNormal:function(){n.allocationModel.uuid.setNormal(),n.allocationModel.path.setNormal()},setFolderFieldError:function(e){var t=f.su.CHAR.ERROR[e]||f.su.CHAR.ERROR["00000006"],e=a.isUsbError(e)?"uuid":"path";n.allocationModel[e].setError(t,!0)},setFolderFieldStatus:function(){a.isUsbUuidError()?a.disableFolderField():a.enableFolderField()},enableFolderField:function(){o.offlineDownloadView.folderField.enable(),n.allocationModel.uuid.getValue()&&!a.isUsbUuidError()&&o.offlineDownloadView.allocationModelTreePath.show()},disableFolderField:function(){o.offlineDownloadView.folderField.disable(),o.offlineDownloadView.allocationModelTreePath.hide()},checkFileName:function(e,t){e=i.vtype.validate(e,{vtype:"string_file",extension:t}),t=a.getDownloadTaskFileFieldName();return!0===e?n.downloadTaskModel[t].setNormal():n.downloadTaskModel[t].setError(e),e},renderFloderTree:function(t,e,o){i.ajax.request({proxy:{extend:"IPFProxy"},preventSuccessEvent:!0,url:f.su.url("/admin/folder_sharing?form=tree"),data:{operation:"load",path:"",uuid:e},ajax:{async:!1},success:function(e){l[t].loadTreeData([e]),o&&o()}})},enableHandler:function(){a.startRefreshTask(),a.setFolderFieldStatus(),a.setDownloadPanelStatus()},disableHandler:function(){a.stopRefreshTask(),a.setFolderFieldStatus(),a.setDownloadPanelStatus(c.DISABLE)},loadOfflineSetting:function(){n.offlineEnableModel.load(),n.offlineSettingModel.load()},submitOfflineSetting:function(){var t=!1,e=n.offlineSettingModel;e.isDirty()&&e.validate()&&((e.scheduleEnable.isDirty()||e.schedule.isDirty())&&(t=!0),e.submit({success:function(){var e=f.Deferred();t?setTimeout(function(){e.resolve()},2e3):e.resolve(),f.when(e).then(a.loadOfflineSetting)}}))},submitFolderPath:function(){n.allocationModel.isDirty()&&n.allocationModel.validate()&&(a.hasDownloadingTask()?o.offlineDownloadView.confirmMsg.show():a.submitAllocationModel())},setDownloadPanelStatus:function(e){var t;e||(t=n.offlineEnableModel.enable.getValue(),e=c["on"==t?"ENABLE":"DISABLE"]),(s=e)==c.ENABLE?o.offlineDownloadView.downloadPanel.show():o.offlineDownloadView.downloadPanel.hide()},hasDownloadingTask:function(){var e;return s!==c.DISABLE&&(e=l.downloadTaskStore.getData(),f.grep(e,function(e){return a.isDownloading(e)}).length)},isDownloading:function(e){return"complete"!==e.status},showOptionField:function(e){f(".source-option").hide(),f(".source-option-"+e).show()},filterTaskField:function(){var e=n.downloadTaskModel,t=e.type.getValue();switch(a.showOptionField(t),t){case"pc":e.btFilePC.enable(),e.btFileVolumn.disable(),e.btFileUSB.disable(),e.url.disable();break;case"usb":e.btFilePC.disable(),e.btFileVolumn.enable(),e.btFileUSB.enable(),e.url.disable();break;case"url":e.btFilePC.disable(),e.btFileVolumn.disable(),e.btFileUSB.disable(),e.url.enable()}},getDownloadTaskFileFieldName:function(){var e=n.downloadTaskModel.type.getValue();return("pc"===e||"usb"===e)&&("pc"==e?"btFilePC":"btFileUSB")},getFileName:function(){var e=n.downloadTaskModel;switch(e.type.getValue()){case"pc":return e.btFilePC.getFileName();case"usb":return e.btFileUSB.getValue()}},uploadFile:function(){var t=f.Deferred();return"pc"!==n.downloadTaskModel.type.getValue()?t.resolve():i.ajax.upload({proxy:"downloadTaskProxy",fileId:"source-pc-file",timeout:5e3,noneEncrypt:!0,success:function(e){t.resolve()},fail:function(){t.reject()},error:function(){t.reject()}}),t},uploadFailCallback:function(){n.downloadTaskModel.btFilePC.setError(f.su.CHAR.ERROR["00000004"])},submitTask:function(e){function t(){a.closeTaskEditor(e)}n.downloadTaskModel.submit({success:t,fail:t,error:t})},closeTaskEditor:function(e){l.downloadTaskStore.getPlugin("popEditor").closeMsgBox(),a.startRefreshTask()},validate:function(){var e,t=n.downloadTaskModel,o=a.getDownloadTaskFileFieldName();return!(!t.validate()||o&&((e=a.getFileName())?!0!==a.checkFileName(e,"torrent"):(t[o].setError(f.su.CHAR.VTYPETEXT.BLANKTEXT),1)))},calculateSpeed:function(e){e=f.su.convertUnit(e,1024,t.length);return parseInt(e.value)+" "+t[e.index]}}})}(jQuery);