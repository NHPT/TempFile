!function(l){l.su.moduleManager.define("storageSharing",{services:["moduleManager","ajax","device"],models:["fileSharing","accessAddress","accessAuthentication","mediaServer","sharingContents"],stores:["storageStatusStore","storageDeviceStore","ftpEncodingStore","accessAddressStore","secureAddressStore","secureAddressPermissionsStore","treeStore"],views:["storageSharingView"],listeners:{ev_on_launch:function(e,s,t,a,r,n,i){s.unRegisterAutoSaveData([a.mediaServer,a.accessAuthentication]),a.accessAuthentication.load(),a.accessAddress.load(),a.mediaServer.load(),r.accessAddressStore.load(),s.storage_proxy_list=["diskListProxy","diskList2Proxy","diskList3Proxy"],this.scanDisk()}},init:function(t,c,r,d,e,u){this.configViews({id:"storageSharingView",items:[{id:"storage-status-group",configs:{nameField:"volumn",fields:[{text:l.su.CHAR.USB_DEVICE.USED,dataIndex:"used",color:"#868484"},{text:l.su.CHAR.USB_DEVICE.AVAILABLE,dataIndex:"free",color:"#4ACBD6"}]}},{id:"storage-device-grid",configs:{columns:[{text:l.su.CHAR.STORAGE_SHARING.DISK,dataIndex:"name",renderer:function(e,s){var t,a=e.match(/.*\(([^)]*)\)/);return a&&(a=a[1],t=l.su.numToCapacity(l.su.capacityToNum(a),1),a)&&t?e.replace(a,t):e}},{text:l.su.CHAR.STORAGE_SHARING.PARTITION,dataIndex:"volumn"},{text:l.su.CHAR.STORAGE_SHARING.TOTAL,dataIndex:"free",xtype:"customWidget",cls:"usb-progress-td m-2-row",width:260,renderer:function(e,s){var t=[];return t[0]=100*(1-l.su.capacityToNum(e)/l.su.capacityToNum(s.capacity)),t[1]="<div class='device-usage-info'><span>"+l.su.CHAR.USB_DEVICE.USED+": "+l.su.numToCapacity(l.su.capacityToNum(s.used),1)+"</span>",t[1]+="<span class='device-usage-free'>&nbsp;&nbsp;&nbsp;&nbsp;"+l.su.CHAR.USB_DEVICE.FREE+": "+l.su.numToCapacity(l.su.capacityToNum(e),1)+"</span></div>",t},widgetName:"progressbar",settings:{labelField:null}},{text:l.su.CHAR.GRID.SHARE,dataIndex:"enable",xtype:"customWidget",widgetName:"switch",cls:"eye-switch-td center-td",settings:{labelField:null,trueValue:"on",falseValue:"off"},width:70},{xtype:"actioncolumn",text:l.su.CHAR.GRID.MODIFY,renderer:function(e,s){var t='<a href="javascript:void(0)" class="grid-content-btn grid-content-custom-btn-delete btn-delete">';t+='<span class="icon"></span>';return'<a href="javascript:void(0)" class="grid-content-btn grid-content-custom-btn-delete btn-delete"><span class="icon"></span><span class="text"></span></a>'}}]}},{id:"access-address-grid",configs:{columns:[{text:l.su.CHAR.STORAGE_SHARING.ACCESS_METHOD,cls:"l-hide xl-hide",renderer:function(){return""}},{text:l.su.CHAR.COMMON.ENABLE,dataIndex:"enable",cls:"status",width:70,xtype:"customWidget",widgetName:"checkbox",settings:{labelField:null,trueValue:"on",falseValue:"off"}},{text:"",cls:"s-hide m-hide",width:100,renderer:function(){return""}},{text:l.su.CHAR.STORAGE_SHARING.ADDRESS_METHOD,dataIndex:"protocol",renderer:function(e,s){return t.getAccessLabel(e)}},{text:l.su.CHAR.STORAGE_SHARING.ADDRESS,dataIndex:"link",cls:"access-address-td",renderer:function(e,s){var t="<div>",e=(t+="<div>"+(null==e?"":e.replace(",","<br />"))+"</div>",u.device.getCurrentDial());return s.edit&&"sftpex"!==s.protocol&&"ocn"!==e&&"v6plus"!==e&&"dslite"!==e&&(t=(t+="<div class='access-method-td-jump-container'>")+"<a class='jump-label address-jump-label' href=\"#ddnsAdv\">"+l.su.CHAR.STORAGE_SHARING.SET_DDNS+"</a></div>"),t+="</div>"}},{text:l.su.CHAR.STORAGE_SHARING.PORT,dataIndex:"port",width:50,cls:"center-td access-address-port-td",xtype:"customWidget",renderer:function(e,s){return!s.edit&&e},widgetName:"textbox",settings:{labelField:null}}]}},{id:"secure-address-grid",configs:{popEditor:{editTitle:l.su.CHAR.STORAGE_SHARING.SECURE_ADDRESS_EDIT_TITLE,content:"#secure-address-grid-pop-editor",fields:[{name:"username"},{name:"password"},{name:"permission"},{name:"folder"},{name:"type"}]},columns:[{text:l.su.CHAR.STORAGE_SHARING.USERNAME,dataIndex:"username"},{text:l.su.CHAR.STORAGE_SHARING.PASSWORD,dataIndex:"password",cls:"password-td",xtype:"customWidget",widgetName:"password",settings:{labelField:null,readOnly:!0}},{text:l.su.CHAR.STORAGE_SHARING.PERMISSIONS,dataIndex:"permission",renderer:function(e){return"r"==e?l.su.CHAR.STORAGE_SHARING.READ:"rw"==e?l.su.CHAR.STORAGE_SHARING.READ_AND_WRITE:void 0}},{text:l.su.CHAR.STORAGE_SHARING.MANAGEMENT,xtype:"actioncolumn",cls:"long",renderer:function(e,s){var t='<a href="javascript:void(0)" class="grid-content-btn grid-content-btn-edit btn-edit">';t+='<span class="icon"></span>';return'<a href="javascript:void(0)" class="grid-content-btn grid-content-btn-edit btn-edit"><span class="icon"></span><span class="text"></span></a>'}}]}}]}),this.control({"#storage-device-grid":{ev_grid_tbar_refresh:function(e){this.scanDisk(!0)}},"#storage-device-grid => a.btn-delete":{ev_grid_action_click:function(e,s){this.removeDisk(d.storageDeviceStore.getModelByKey(s).serial.getValue())}},"#access-address-grid => a.address-jump-label":{click:function(){r.accessAuthentication.isDirty()||r.accessAddress.isDirty()||d.accessAddressStore.isDirty()?c.storageSharingView.gotoDdnsConfirmMsg.show():setTimeout(function(){u.moduleManager.get("navigatorController").goTo("ddnsAdv")},20)}},"#secure-address-grid":{ev_grid_before_save:function(e,s,t){for(var a=c.storageSharingView.secureUsername.getValue(),r=d.secureAddressStore.getData(),n=r.length,i=0;i<n;i++)if(r[i]["key"]!=t&&r[i]["username"]==a)return s.preventDefault(),c.storageSharingView.secureUsername.setError(l.su.CHAR.STORAGE_SHARING.USERNAME_CONFLICT),!1;return!0}},"#secure-address-grid => a.grid-content-folder-edit":{ev_grid_action_click:function(e,s){c.storageSharingView.secureAddressFolderEditMsg.show()}},"#go-to-ddns-confirm-msg":{ev_msg_ok:function(){setTimeout(function(){u.moduleManager.get("navigatorController").goTo("ddnsAdv")},20)}},"#storage-status-group => .btn-refresh":{click:function(){this.scanDisk(!0)}},"#scan-device":{ev_button_click:function(){c.storageSharingView.scanButton.loading(!0),this.scanDisk(!0)}},"#remove-device":{ev_button_click:function(){this.removeDisk()}}}),this.listen({"stores.storageDeviceStore":{ev_data_change:function(e,s,t){var a,r=d.storageDeviceStore.checkDataChange().update;for(a in r)this.updateDisk(r[a].model.serial,{operation:"update",index:r[a].index,key:r[a].model.key,old:JSON.stringify(r[a].oldModel),new:JSON.stringify(r[a].model)})}},"models.accessAuthentication.authentication":{ev_value_change:function(e,a,s){u.ajax.request({proxy:"secureAddressProxy",data:{operation:"load"},success:function(e){for(var s,t=0;t<e.length;t++)if("ADMIN"==e[t].username.toUpperCase()){s=e[t];break}"on"===a?d.secureAddressStore.loadData(e):"off"===a&&d.secureAddressStore.loadData([s])}}),r.accessAuthentication.isDirty()&&r.accessAuthentication.submit()}},"models.mediaServer.mediaSharing":{ev_value_change:function(e,s,t){r.mediaServer.isDirty()&&r.mediaServer.submit()}},"stores.accessAddressStore":{ev_will_auto_save:function(e,s){s.preventDefault(),d.accessAddressStore.isDirty()&&t.submitAccessData({success:function(e){d.accessAddressStore.load()}})},ev_loaded:function(){var t,a,r,e,s,n,i=u.device.getCurrentDial(),o=c.storageSharingView.disableInternetFTP;("ocn"===i||"v6plus"===i||"dslite"===i)&&(t=d.accessAddressStore,(n=l.grep(t.getStoreData(),function(e,s){return"ftpex"===e.protocol||"sftpex"===e.protocol})).length)?(r=a=!1,l.each(n,function(e,s){a=a||"ftpex"===s.protocol,r=r||"sftpex"===s.protocol,t.getModelByKey(s.key).disableRow(!0)}),n="",e=l.su.CHAR.STORAGE_SHARING.ACCESS_METHOD_INTERNET_FTP,a&&r?(s={dslite:l.su.CHAR.NETWORK_INTERNET.DSLITE,v6plus:l.su.CHAR.NETWORK_INTERNET.V6_PLUS,ocn:l.su.CHAR.NETWORK_INTERNET.OCN},n=(n="The feature is unavailable when the internet connection type is set to %dialType%.").replace("%dialType%",s[i]),e+=" / "+l.su.CHAR.STORAGE_SHARING.ACCESS_METHOD_INTERNET_SFTP):(r&&(e=l.su.CHAR.STORAGE_SHARING.ACCESS_METHOD_INTERNET_SFTP),n={dslite:l.su.CHAR.NETWORK_INTERNET.DSLITE_CONFLICT_TIPS,v6plus:l.su.CHAR.NETWORK_INTERNET.V6PLUS_CONFLICT_TIPS,ocn:l.su.CHAR.NETWORK_INTERNET.OCN_CONFLICT_TIPS}[i]),o.setField("ACCESS_METHOD",e),o.setField("DISALBE_TIP",n),o.show()):o.hide()}},"models.accessAddress":{ev_will_auto_save:function(e,s){s.preventDefault(),r.accessAddress.isDirty()&&r.accessAddress.server.validate()&&t.submitAccessData({success:function(e){r.accessAddress.loadData({server:r.accessAddress.server.getValue()})}})}}})}},function(d,a,n,u,e,i){var d=this,o=[],s=[],c=[];return{scanDisk:function(e){o=[],c=[],i.ajax.request({url:e?l.su.url("/admin/disk_setting?form=scan"):l.su.url("/admin/disk_setting?form=metadata"),data:{operation:"scan"},preventSuccessEvent:!0,success:function(e){var s=e["number"],r=e.list;if(l("#storage-status-group").hide(),l("#remove-device").hide(),u.storageDeviceStore.hide(),a.storageSharingView.noUSBTips.hide(),a.storageSharingView.scanButton.loading(!1),a.storageSharingView.scanButton.hide(),0==s)a.storageSharingView.noUSBTips.show(),a.storageSharingView.scanButton.show(),u.treeStore.loadTreeData([]);else{u.storageDeviceStore.show(),o=r;for(var t=0,n=0;t<s;t++)!function(a){i.ajax.request({proxy:{extend:"IPFProxy"},url:l.su.url("/admin/disk_setting?form=contents&serial="+r[a].serial),preventSuccessEvent:!0,data:{operation:"load"},ajax:{async:!1},success:function(t){o[a].num=a,c[a]=[],l.each(t,function(e,s){t[e].serial=r[a].serial,t[e].name=r[a].name,c[a].push(n),n++}),o[a].volumnList=t}})}(t);d.renderData()}},fail:function(e,s,t){},error:function(){}})},renderData:function(){s=[];for(var e=0;e<o.length;e++)s=s.concat(o[e].volumnList);u.storageDeviceStore.loadData(s),d.renderRow(s),d.renderFolder(s)},renderRow:function(e){u.storageDeviceStore.rowSpan(1,c),u.storageDeviceStore.rowSpan(5,c),u.storageDeviceStore.rowMerge(c)},renderFolder:function(e){for(var s,t=[],a=e.length,r=0;r<a;r++)s=r,i.ajax.request({proxy:{extend:"IPFProxy"},preventSuccessEvent:!0,url:l.su.url("/admin/folder_sharing?form=tree"),data:{operation:"load",path:"",uuid:e[s].uuid},ajax:{async:!1},success:function(e){t.push(e)}});u.treeStore.loadTreeData(t),d.unRegisterAutoSaveData([n.sharingContents]),n.sharingContents.load({success:d.sharingContentsCallback,fail:d.sharingContentsCallback,error:d.sharingContentsCallback})},sharingContentsCallback:function(){d.registerAutoSaveData([n.sharingContents])},removeDisk:function(e){i.ajax.request({url:l.su.url("/admin/disk_setting?form=remove"),data:{operation:"remove",serial:e},success:function(e){d.scanDisk()},fail:function(e,s,t){},error:function(){}})},updateDisk:function(e,s){i.ajax.request({url:l.su.url("/admin/disk_setting?form=contents&serial="+e),data:s,success:function(e){d.scanDisk()},fail:function(e,s,t){},error:function(){}})},submitAccessData:function(e){var a={},r=!0;a.server=n.accessAddress.getData().server,a.enable=[],l.each(u.accessAddressStore.getData(),function(e,s){var t=d.checkPort(s);if(!t)return r=!1;switch("object"==typeof t&&l.extend(a,t),s.protocol){case"sftp":a.sftpenable=s.enable;break;case"sftpex":a.sftpexenable=s.enable;break;default:a.enable.push(s.enable)}}),r&&(a.enable=a.enable.join(),i.ajax.request(l.extend({},{proxy:"accessAddressProxy",data:a},e)))},checkPort:function(e){if(!e.edit)return!0;var s=e.port,t=u.accessAddressStore,a={},r=void 0,n="",i=d.getAccessLabel(e.protocol),o=!1,n="sftpex"===e.protocol?(a.sftpport=s,l.su.CHAR.NETWORK_INTERNET.VALUE_TIPS.replace("%min",1024).replace("%max",65535)):(a.port=s,l.su.CHAR.ERROR["00000042"].replace("80",r=21));do{if(!/^\d+$/.test(s))break;var c=parseInt(s);if(r&&c==r||c<=65535&&1024<=c){o=!0;break}}while(0);return o?a:(t.setMaxRules("","",i+": "+n),t.showMaxRulesWarning(),t.getSubModelBindByKey(e.key).port.getInnerWidget().setError(),!1)},getAccessLabel:function(e){switch(e=e.toUpperCase()){case"SAMBA":return l.su.CHAR.STORAGE_SHARING.ACCESS_METHOD_SAMBA_WINDOWS;case"FTP":return l.su.CHAR.STORAGE_SHARING.ACCESS_METHOD_LOCAL_FTP;case"FTPEX":return l.su.CHAR.STORAGE_SHARING.ACCESS_METHOD_INTERNET_FTP||l.su.CHAR.STORAGE_SHARING.ACCESS_METHOD_INTERNET_SFTP.replace("SFTP","FTP");case"SFTP":return l.su.CHAR.STORAGE_SHARING.ACCESS_METHOD_LOCAL_SFTP||l.su.CHAR.STORAGE_SHARING.ACCESS_METHOD_LOCAL_FTP.replace("FTP","SFTP");case"SFTPEX":return l.su.CHAR.STORAGE_SHARING.ACCESS_METHOD_INTERNET_SFTP;default:return e}}}})}(jQuery);