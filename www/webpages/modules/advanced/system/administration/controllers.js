!function(r){r.su.moduleManager.define("administration",{models:["changePwdModel","pwdRecoveryModel","localMngtModel","localMngtHttpModel","newDeviceModel","remoteMngtModel","autoLogoutModel","lanAdvLanModel","ipv4Status"],stores:["localMngtDeviceStore","remoteMngtDeviceStore","allowDeviceStore","portForwardingConnectedDevicesStore"],services:["ajax","device"],deps:["utils"],views:["administrationView"],listeners:{ev_on_launch:function(e,i,t,n,o,a,d){r.su.IS_RG_SEC?(n.localMngtHttpModel.httpsEnable.hide(),n.localMngtHttpModel.httpsEnable.disable()):(n.localMngtHttpModel.httpsEnable.show(),n.localMngtHttpModel.httpsEnable.enable()),i.oldPwdKey=null,i.newPwdKey=null,i.cfmPwdKey=null,i.virtualPortList=[],"ap"===d.device.getCurrentMode()&&(t.administrationView.recoveryPanel.hide(),t.administrationView.remoteMngtCtn.hide()),t.administrationView.changePasswordPanel.show(),t.administrationView.recoveryPanel.show(),n.changePwdModel.load({success:function(){var e=n.changePwdModel.getData();i.oldPwdKey=e.oldPwd,i.newPwdKey=e.newPwd,i.cfmPwdKey=e.cfmPwd}}),n.ipv4Status.load({ajax:{async:!1},success:function(){var e={dslite:r.su.CHAR.NETWORK_INTERNET.DSLITE_CONFLICT_TIPS,v6plus:r.su.CHAR.NETWORK_INTERNET.V6PLUS_CONFLICT_TIPS,ocn:r.su.CHAR.NETWORK_INTERNET.OCN_CONFLICT_TIPS}[n.ipv4Status.conntype.getValue()],t=n.remoteMngtModel.enable;e?(t.disable(),t.setTips(e),i.FEATURE_ENABLE=!1):t.enable()}}),n.localMngtModel.load(),n.localMngtHttpModel.load(),n.pwdRecoveryModel.load({success:function(e){i.recovertPwdKey=e.password}}),n.remoteMngtModel.load(),o.allowDeviceStore.load(),n.lanAdvLanModel.load({success:function(e){e=n.lanAdvLanModel.getData();switch(i.lanIP=e.ipaddr,e.maskType){case 0:i.lanMask="255.255.255.0";break;case 1:i.lanMask="255.255.0.0";break;case 2:i.lanMask="255.0.0.0";break;case 3:i.lanMask=e.customValue}}}),i.getVirtualPort({success:function(e){for(var t=0,n=e.length;t<n;t++){var o=e[t].enable,a=e[t].protocol.toUpperCase(),d=e[t].externalPort;"on"==o&&"UDP"!==a&&i.virtualPortList.push(d)}}})}},init:function(o,a,i,l,e,t){this.configViews({id:"administrationView",items:[{id:"allowed-devices-grid",configs:{minLines:0,tbar:{add:{text:r.su.CHAR.ADMINISTRATION.ADD_DEVICE,index:0}},popEditor:{addTitle:r.su.CHAR.ADMINISTRATION.ADD_DEVICE,content:"#allow-deivce-popEditor",fields:[{name:"description"},{name:"mac"}]},columns:[{xtype:"checkcolumn",width:20},{text:r.su.CHAR.ADMINISTRATION.DESCRIPTION,dataIndex:"description"},{text:r.su.CHAR.ADMINISTRATION.MAC,dataIndex:"mac"},{xtype:"actioncolumn",text:r.su.CHAR.ADMINISTRATION.OPERATION,renderer:function(e,t){var n="";return t.host||(n+='<a href="javascript:void(0)" class="grid-content-btn grid-content-btn-delete btn-delete"><span class="icon"></span><span class="text"></span></a>'),n}}]}},{id:"connect-device-list",configs:[{type:"logo",dataIndex:"deviceType"},{type:"deviceName",dataIndex:"name"},{type:"mac",dataIndex:"macAddress"},{type:"ip",dataIndex:"ipAddress"}]}]}),this.listen({"models.pwdRecoveryModel.enableRec":{ev_value_change:function(e,t,n){"on"===t?a.administrationView.recoveryFieldset.show():a.administrationView.recoveryFieldset.hide()}},"models.pwdRecoveryModel.enableAuth":{ev_value_change:function(e,t,n){"on"===t?a.administrationView.recoveryAuthFieldset.show():a.administrationView.recoveryAuthFieldset.hide()}},"models.localMngtModel.mode":{ev_value_change:function(e,t,n){"all"===t?l.allowDeviceStore.hide():l.allowDeviceStore.show()}},"models.remoteMngtModel.enable":{ev_value_change:function(e,t,n){o.FEATURE_ENABLE&&"on"===t?(a.administrationView.remoteMngtFieldset.show(),i.remoteMngtModel.webAddress.enable(),"all"===i.remoteMngtModel.managers.getValue()?(i.remoteMngtModel.ipaddr.hide(),i.remoteMngtModel.ipaddr.disable()):(i.remoteMngtModel.ipaddr.show(),i.remoteMngtModel.ipaddr.enable())):(a.administrationView.remoteMngtFieldset.hide(),i.remoteMngtModel.webAddress.disable())}},"models.remoteMngtModel.managers":{ev_value_change:function(e,t){"all"===t?(i.remoteMngtModel.ipaddr.hide(),i.remoteMngtModel.ipaddr.disable()):(i.remoteMngtModel.ipaddr.show(),i.remoteMngtModel.ipaddr.enable())}},"models.changePwdModel":{ev_will_auto_save:function(e,t){i.changePwdModel.oldPwd.setValue(i.changePwdModel.oldPwdInput.doEncrypt(o.oldPwdKey)),i.changePwdModel.newPwd.setValue(i.changePwdModel.newPwdInput.doEncrypt(o.newPwdKey)),i.changePwdModel.cfmPwd.setValue(i.changePwdModel.cfmPwdInput.doEncrypt(o.cfmPwdKey))},ev_auto_saved:function(){r.encrypt.encryptManager.cleanStorage(),location.href="/"},ev_model_submit_complete:function(e,t,n){"update account failed"===n&&i.changePwdModel.oldPwdInput.setError(r.su.CHAR.ERROR.E5002)}},"models.pwdRecoveryModel":{ev_will_auto_save:function(e,t){i.pwdRecoveryModel.password.setValue(i.pwdRecoveryModel.passwordInput.doEncrypt(o.recovertPwdKey))}}}),this.control({".index-common-save-btn":{ev_will_auto_save:function(e,t){o.validatePassword()||t.preventDefault(),o.validateRemoteManagement()||t.preventDefault()}},"#allowed-devices-grid":{ev_grid_tbar_add:function(e,t){i.newDeviceModel.description.setValue(""),i.newDeviceModel.mac.setNormal()},ev_grid_before_save:function(e,t){for(var n=i.newDeviceModel.mac.getValue(),o=l.allowDeviceStore.getData(),a=0,d=o.length;a<d;a++)if(o[a].mac===n)return i.newDeviceModel.mac.setError(r.su.CHAR.ERROR["00000007"]),t.preventDefault(),!1}},"#connect-device-list":{ev_item_click:function(e,t){i.newDeviceModel.description.setValue(t.name),i.newDeviceModel.mac.setValue(t.macAddress),a.administrationView.connectDeviceMsg.hide()}},"#connect-device-btn":{ev_button_click:function(){l.portForwardingConnectedDevicesStore.load(),a.administrationView.connectDeviceMsg.show()}},"#remote-conflict-confirm":{ev_msg_ok:function(){for(var e=[i.changePwdModel,i.pwdRecoveryModel,i.localMngtModel,i.localMngtHttpModel,i.remoteMngtModel],t=e.length,n=0;n<t;n++)if(e[n].isDirty()&&!e[n].validate())return;for(n=0;n<t;n++)e[n].isDirty()&&e[n].submit()}}})}},function(a,d,i,e,l,o){return{FEATURE_ENABLE:!0,getCloudLogin:function(e){var t,n;e&&(t=e.success,n=e.fail),o.ajax.request({proxy:"checkFirstLoginProxy",success:function(e){t&&t(e)},fail:function(e){n&&n(e)}})},getVirtualPort:function(e){var t;e&&(t=e.success),o.ajax.request({proxy:"virtualPortProxy",success:function(e){t&&t(e)}})},conflictPort:function(e,t){e=parseInt(e,10);for(var n=0,o=t.length;n<o;n++)if(0<=t[n].indexOf("-")){var a=t[n].split("-");if(e>=parseInt(a[0],10)&&e<=parseInt(a[1],10))return!0}else if(e==parseInt(t[n],10))return!0;return!1},validatePassword:function(){var e,t,n=i.changePwdModel;return!(n.isDirty()&&(n.oldPwdInput.getValue(),e=n.newPwdInput.getValue(),t=n.cfmPwdInput.getValue(),!n.validate()||e!==t&&(n.cfmPwdInput.setError(r.su.CHAR.ERROR["00000080"]),1)))},validateRemoteManagement:function(){var e,t,n,o=i.remoteMngtModel;return!(o.isDirty()&&"off"!==i.remoteMngtModel.enable.getValue()&&(e=o.httpsPort.getValue(),t=o.managers.getValue(),n=o.ipaddr.getValue(),!o.validate()||("partial"===t&&l.utils.isSameNet(n,a.lanIP,a.lanMask)?(o.ipaddr.setError(r.su.CHAR.ERROR["00000056"]),1):a.conflictPort(e,a.virtualPortList)&&(d.administrationView.remoteConflictConfirm.show(),1))))}}})}(jQuery);