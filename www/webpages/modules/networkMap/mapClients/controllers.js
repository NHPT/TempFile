!function(p){var c="all",u={"2g":{type:"2g",text:p.su.CHAR.NETWORK_MAP.G24,iconCls:"show_24G"},"5g":{type:"5g",text:p.su.CHAR.NETWORK_MAP.G5,iconCls:"show_5G"},"5g1":{type:"5g-1",text:p.su.CHAR.NETWORK_MAP.G5_1,iconCls:"show_51G"},"5g2":{type:"5g-2",text:p.su.CHAR.NETWORK_MAP.G5_2,iconCls:"show_52G"},"6g":{type:"6g",text:p.su.CHAR.NETWORK_MAP.G6,iconCls:"show_6G"},offline:{text:p.su.CHAR.NETWORK_MAP.OFFLINE,iconCls:"show_offline"},wired:{text:p.su.CHAR.NETWORK_MAP.WIRED,iconCls:"show_LAN"},all:{text:p.su.CHAR.NETWORK_MAP.ALL}};p.su.moduleManager.define("mapClients",{services:["ajax","timer","device","vtype"],deps:["networkMap","navigatorController"],models:["statusAll","accessControl","accessControlEnableM","speedLimitModel"],stores:["clientFilterOptions","connectedClientsStore","onlineDeviceStore","bandwidthUnitStore","speedLimitDownloadStore","speedLimitUploadStore"],views:["mapClientsView"],listeners:{ev_on_launch:function(e,t,i,n,a,s,l){this.unRegisterAutoSaveData([a.connectedClientsStore,a.onlineDeviceStore,n.speedLimitModel]),"router"===l.device.getCurrentMode()&&l.ajax.request({proxy:"getSpeedLimitMaxProxy",data:{operation:"read_max"},success:function(e){t.currentDownloadLimitMax=(parseInt(e.downloadLimitMax)/1024).toFixed(0),t.currentUploadLimitMax=(parseInt(e.uploadLimitMax)/1024).toFixed(0),t.speedLimitMaxRules=parseInt(e.max_rules)}}),t.getClients(),t.getAccessControlMode({success:function(e){"black"===e.accessMode?i.mapClientsView.mapClientsAccessControlBtn.setText(p.su.CHAR.NETWORK_MAP.VIEW_BLACKLIST):i.mapClientsView.mapClientsAccessControlBtn.setText(p.su.CHAR.NETWORK_MAP.VIEW_WHITELIST),i.mapClientsView.blockConfirmMsg.setContent(p.su.CHAR.NETWORK_MAP.BLOCK_MSG_BLACKLIST)}}),"ap"==l.device.getCurrentMode()&&a.connectedClientsStore.hideColumn("downloadSpeed")},ev_before_destroy:function(e,t){t.beforeDestroy()}},init:function(o,d,c,r,t,n){var m=n.device.getConfig().supportSpeedLimit&&"router"===n.device.getCurrentMode();this.configViews({id:"mapClientsView",items:[{id:"connected-clients-grid",cls:" container widget-container "+(m?"speed-limit-grid ":""),configs:{columns:[{dataIndex:"deviceName",cls:"m-hide l-hide xl-hide label-empty",renderer:function(e,t){e="<div>"+e;return e+='<div class="phone edit" deviceName="'+t.deviceName+'" mac="'+t.mac+'"></div></div>'}},{dataIndex:"deviceType",cls:"m-hide l-hide xl-hide label-empty",renderer:function(e,t){var i="",i=(i=(i+=o.generateDeviceIcon(t))+'<div class="device-info-container widget-container">'+('<div class="mac">'+t.mac+"</div>"))+('<div class="ip">'+("0.0.0.0"==t.ip?"":t.ip)+"</div>");return m&&(i+='<span class="mode '+((t=t.networkMode)&&u[t]["iconCls"])+'"></span>'),i+="</div>"}},{text:m?p.su.CHAR.NETWORK_MAP.DEVICE_INFO:p.su.CHAR.NETWORK_MAP.TYPE,dataIndex:"deviceName",width:m?220:"10%",cls:"s-hide",renderer:function(e,t){var i,n="";return n+=o.generateDeviceIcon(t),m&&"object"===p.type(t)&&(n=(n=(n+='<div class="device-info-container widget-container">')+'<div class="name" title="'+e+'">'+e+'</div><div class="mac">'+t.mac+"</div>")+'<div class="ip">'+("0.0.0.0"==t.ip?"":t.ip)+"</div>",n=(n+='<span class="mode '+((i=t.networkMode)&&u[i]["iconCls"])+'"></span>')+'<div class="edit" deviceName="'+e+'" mac="'+t.mac+'"></div></div>'),n}},{text:p.su.CHAR.NETWORK_MAP.INFORMATION,dataIndex:"deviceName",cls:"s-hide",hideColumn:m,renderer:function(e,t){var i="";return i="object"===p.type(t)?(i=(i=(i+='<div class="device-info-container widget-container">')+'<div class="name" title="'+e+'">'+e+'</div><div class="mac">'+t.mac+"</div>")+'<div class="ip">'+("0.0.0.0"==t.ip?"":t.ip)+"</div>")+'<div class="edit" deviceName="'+e+'" mac="'+t.mac+'"></div></div>':i}},{text:p.su.CHAR.NETWORK_MAP.REAL_TIME_RATE,dataIndex:"downloadSpeed",renderer:function(e,t){var i,n;return m&&!1===t.speedLimitOnline?'<div class="real-time-offline">---</div>':(i="","object"===p.type(t)&&(n=o.convertSpeedVal(t.downloadSpeed),i=(i=(i=(i=(i+='<div class="speed-upload-container widget-container">')+'<span class="icon"></span><span class="text">'+(t=o.convertSpeedVal(t.uploadSpeed)).speed+"</span>")+'<span class="unit">'+t.unit+'</span></div><div class="speed-download-container widget-container">')+'<span class="icon"></span><span class="text">'+n.speed+"</span>")+'<span class="unit">'+n.unit+"</span></div>"),i)}},{text:p.su.CHAR.NETWORK_MAP.INTERFACE,dataIndex:"networkMode",width:"15%",cls:"center-td s-2-col",hideColumn:m,renderer:function(e,t){var i="",n="";if(!e)return"---";switch(e){case"wired":i="<span class='icon icon-interface'></span>";break;case"offline":i=u[e]["text"];break;default:i="<span class='icon icon-wireless signal-%signal%'></span><span class='text text-%mode%'>%text%</span>".replace("%signal%",o.convertSignal(t.signal)).replace("%mode%",u[e]["type"]).replace("%text%",u[e]["text"])}return(n+='<div class="interface-container widget-container">')+i+"</div>"}},{text:p.su.CHAR.NETWORK_MAP.TXRX,dataIndex:"txrate",cls:"center-td",width:"15%",renderer:function(e,t){var i,n,a;return m&&!1===t.speedLimitOnline?"---":(i='<div class="interface-container widget-container">',n="---",e=o.convertRate(e),a=o.convertRate(t.rxrate),"wired"!==t.deviceTag&&"offline"!==t.deviceTag&&null!=e&&(i+="<span class='icon icon-wireless signal-"+o.convertSignal(t.signal)+"'></span>",-1!==e.indexOf("-")&&-1!==a.indexOf("-")||(n=e+" / "+a)),m?(i+='<span class="text">')+n+"</span></div>":n)}},{text:p.su.CHAR.NETWORK_MAP.DURATION,dataIndex:"remainTime",width:"15%",cls:"center-td "+(m?"":"s-last-td"),renderer:function(e,t){var i,n,a;return m&&!1===t.speedLimitOnline?"---":(t=t.onlineTime,a="",a+='<div class="duration-container widget-container">',i=parseInt(t/86400,10),n=parseInt(t%86400/3600,10),t=parseInt(t%3600/60,10),1===i?a=a+i+" "+p.su.CHAR.NETWORK_MAP.DAY+" ":1<i&&(a=a+i+" "+p.su.CHAR.NETWORK_MAP.DAYS+" "),(a=(a=0<n?a+n+" "+p.su.CHAR.NETWORK_MAP.H+" ":a)+t+" "+p.su.CHAR.NETWORK_MAP.MIN)+"</div>")}},{text:p.su.CHAR.NETWORK_MAP.SPEED_LIMIT,dataIndex:"enableLimit",cls:"s-last-td center-td",hideColumn:!m,renderer:function(e,t){var i,n,a;return!0===t.isGuest?"---":(n=o.convertSpeedLimitVal(t.downloadLimit,!(i="")),a=o.convertSpeedLimitVal(t.uploadLimit,!0),i+='<div class="speed-limit-info-container">',"object"===p.type(t)&&"off"!==e?(i+='<div class="speed-upload-container widget-container"><span class="icon"></span>',-1!==t.uploadLimit?i=(i+='<span class="text">'+a.speed+"</span>")+'<span class="unit">'+a.unit+"</span>":i+="---",i+='</div><div class="speed-download-container widget-container"><span class="icon"></span>',-1!==t.downloadLimit?i=(i+='<span class="text">'+n.speed+"</span>")+'<span class="unit">'+n.unit+"</span>":i+="---",i+="</div>"):i+='<div class="empty-content">---</div>',i+('<div class="edit-limit" key="'+t.key)+'"></div></div>')}},{text:p.su.CHAR.NETWORK_MAP.BLOCK,xtype:"actioncolumn",dataIndex:"block",width:"10%",renderer:function(e,t){if(m&&!1===t.speedLimitOnline)return"---";for(var i=r.onlineDeviceStore.getData(),n="",a=0,s=i.length;a<s;a++)i[a].mac==t.mac&&(n="HOST"==i[a].host?"disabled":"");var l="";return l+('<a href="javascript:void(0)" class="grid-content-btn btn-block '+n+'">')+'<span class="icon"></span>'+'<span class="text"></span>'+"</a>"}}]}}]}),this.control({"#connected-clients-grid => .btn-block":{ev_grid_action_click:function(e,t){-1<e.target.className.indexOf("disable")||(e=r.connectedClientsStore.getModelByKey(t),o.blockData={key:e.key.getValue(),deviceType:e.deviceType.getValue(),name:e.deviceName.getValue(),mac:e.mac.getValue(),ipaddr:e.ip.getValue(),conn_type:"wireless",host:"NOT HOST"},d.mapClientsView.blockConfirmMsg.show())}},"#connected-clients-grid => .edit":{click:function(e,t){d.mapClientsView.clientNameMsg.show(),d.mapClientsView.clientNameModelAlias.setValue(p(e.currentTarget).attr("deviceName")),d.mapClientsView.clientNameModelMac.setValue(p(e.currentTarget).attr("mac"))}},"#client-name-msg":{ev_msg_ok:function(e,t){var i;!0===o.checkDeviceName(d.mapClientsView.clientNameModelAlias.getValue())?(n.ajax.request({data:{operation:"write",mac:d.mapClientsView.clientNameModelMac.getValue(),alias:d.mapClientsView.clientNameModelAlias.getValue()},proxy:"changeDeviceNameProxy",success:function(e){p.each(r.connectedClientsStore.getData(),function(e,t){t.mac==d.mapClientsView.clientNameModelMac.getValue()&&(p("[data-key="+t.key+"] .device-info-container .name").text(d.mapClientsView.clientNameModelAlias.getValue()),p("#connected-clients-grid_tr_"+t.key+"_td_1 .content div").html(d.mapClientsView.clientNameModelAlias.getValue()+'<div class="phone edit" devicename="'+d.mapClientsView.clientNameModelAlias.getValue()+'" mac="'+d.mapClientsView.clientNameModelMac.getValue()+'"></div>'))})}}),d.mapClientsView.clientNameMsg.hide()):(i=p.su.CHAR.VTYPETEXT.DEVICE_NAME_INVALID,(d.mapClientsView.clientNameModelAlias.getValue().length<1||64<d.mapClientsView.clientNameModelAlias.getValue().length)&&(i=p.su.CHAR.VTYPETEXT.LEN_MIN_MAX.replace("%min",1).replace("%max",64)),d.mapClientsView.clientNameModelAlias.setError(i)),t.preventDefault()},ev_msg_cancel:function(e,t){}},"#map-clients-access-control-btn":{ev_button_click:function(e){t.navigatorController.goTo("accessControl")}},"#block-confirm-msg":{ev_msg_ok:function(e){o.blockDevice(o.blockData)}},"#connected-clients-grid => .edit-limit":{click:function(e,t){for(var i=r.connectedClientsStore.getData(),n=0,a=0;a<i.length;a++)"on"==i[a].enableLimit&&n++;t=p(e.currentTarget).attr("key"),e=r.connectedClientsStore.getModelByKey(t);if(n>=o.speedLimitMaxRules&&"off"==e.enableLimit.getValue())d.mapClientsView.speedLimitMaxRulesTip.setText(p.su.CHAR.NETWORK_MAP.MAX_RULES_WARN.replace("%max%",o.speedLimitMaxRules)),d.mapClientsView.speedLimitMaxRulesMsg.show();else{c.speedLimitModel.mac.setValue(e.mac.getValue()),c.speedLimitModel.enableLimit.setValue(e.enableLimit.getValue()),d.mapClientsView.speedLimitMsg.show(),!0===e.enablePriority.getValue()?o.currentEnablePriority=!0:o.currentEnablePriority=!1;var s=e.downloadLimit.getValue(),l=e.uploadLimit.getValue();if(c.speedLimitModel.downloadLimit.setValue(""),c.speedLimitModel.downloadLimitUnit.setValue("mbps"),c.speedLimitModel.uploadLimit.setValue(""),c.speedLimitModel.uploadLimitUnit.setValue("mbps"),-1===s)c.speedLimitModel.downloadLimitType.setValue("none");else switch(s){case 0:c.speedLimitModel.downloadLimitType.setValue("none");break;case 1024:c.speedLimitModel.downloadLimitType.setValue("1mbps");break;case 10240:c.speedLimitModel.downloadLimitType.setValue("10mbps");break;default:c.speedLimitModel.downloadLimitType.setValue("custom"),s<1024?(c.speedLimitModel.downloadLimit.setValue(s.toFixed(0)),c.speedLimitModel.downloadLimitUnit.setValue("kbps")):(c.speedLimitModel.downloadLimit.setValue((s/1024).toFixed(0)),c.speedLimitModel.downloadLimitUnit.setValue("mbps"))}if(-1===l)c.speedLimitModel.uploadLimitType.setValue("none");else switch(l){case 0:c.speedLimitModel.uploadLimitType.setValue("none");break;case 200:c.speedLimitModel.uploadLimitType.setValue("200kbps");break;case 2048:c.speedLimitModel.uploadLimitType.setValue("2mbps");break;default:c.speedLimitModel.uploadLimitType.setValue("custom"),l<1024?(c.speedLimitModel.uploadLimit.setValue(l.toFixed(0)),c.speedLimitModel.uploadLimitUnit.setValue("kbps")):(c.speedLimitModel.uploadLimit.setValue((l/1024).toFixed(0)),c.speedLimitModel.uploadLimitUnit.setValue("mbps"))}}}},"#speed-limit-enable":{ev_view_change:function(e,t,i){"on"==t.value&&1==o.currentEnablePriority&&d.mapClientsView.speedLimitPriorityMsg.show()}},"#speedlimit-priority-conflict-msg":{ev_msg_ok:function(e){},ev_msg_cancel:function(e){c.speedLimitModel.enableLimit.setValue("off")}},"#speed-limit-msg":{ev_msg_ok:function(e,t){return c.speedLimitModel.validate()?"none"==c.speedLimitModel.downloadLimitType.getValue()&&"none"==c.speedLimitModel.uploadLimitType.getValue()?(c.speedLimitModel.downloadLimitType.setError(p.su.CHAR.NETWORK_MAP.NO_LIMITS_ERROR),t.preventDefault()):void c.speedLimitModel.submit({success:function(){o.loadClientListStore("loadDevice")}}):t.preventDefault()}}}),this.listen({"views.mapClientsView.clientFilterType":{ev_value_change:function(e,t){o.filterClients(t)}},"models.speedLimitModel.enableLimit":{ev_value_change:function(e,t,i){"on"==t?(d.mapClientsView.speedLimitEditBlock.show(),"custom"==c.speedLimitModel.downloadLimitType.getValue()?(d.mapClientsView.downloadLimitCustom.show(),d.mapClientsView.downloadLimitCustom.enable()):(d.mapClientsView.downloadLimitCustom.hide(),d.mapClientsView.downloadLimitCustom.disable()),"custom"==c.speedLimitModel.uploadLimitType.getValue()?(d.mapClientsView.uploadLimitCustom.show(),d.mapClientsView.uploadLimitCustom.enable()):(d.mapClientsView.uploadLimitCustom.hide(),d.mapClientsView.uploadLimitCustom.disable())):d.mapClientsView.speedLimitEditBlock.hide()}},"models.speedLimitModel.downloadLimitType":{ev_value_change:function(e,t,i){switch(d.mapClientsView.downloadLimitCustom.hide(),d.mapClientsView.downloadLimitCustom.disable(),t){case"1mbps":c.speedLimitModel.downloadLimitType.setTips(p.su.CHAR.NETWORK_MAP.SPEED_1_MBPS_TIPS);break;case"10mbps":c.speedLimitModel.downloadLimitType.setTips(p.su.CHAR.NETWORK_MAP.SPEED_10_MBPS_TIPS);break;case"custom":d.mapClientsView.downloadLimitCustom.show(),d.mapClientsView.downloadLimitCustom.enable(),c.speedLimitModel.downloadLimitType.setTips("");break;default:c.speedLimitModel.downloadLimitType.setTips("")}}},"models.speedLimitModel.uploadLimitType":{ev_value_change:function(e,t,i){d.mapClientsView.uploadLimitCustom.hide(),d.mapClientsView.uploadLimitCustom.disable(),"custom"==t&&(d.mapClientsView.uploadLimitCustom.show(),d.mapClientsView.uploadLimitCustom.enable())}},"models.speedLimitModel.downloadLimitUnit":{ev_value_change:function(e,t,i){"kbps"===t?(c.speedLimitModel.downloadLimit.setTips("(1-1024)"),c.speedLimitModel.downloadLimit.setVtype({vtype:"number",min:1,max:1024})):(c.speedLimitModel.downloadLimit.setTips("(1-"+o.currentDownloadLimitMax+")"),c.speedLimitModel.downloadLimit.setVtype({vtype:"number",min:1,max:o.currentDownloadLimitMax}))}},"models.speedLimitModel.uploadLimitUnit":{ev_value_change:function(e,t,i){"kbps"===t?(c.speedLimitModel.uploadLimit.setTips("(1-1024)"),c.speedLimitModel.uploadLimit.setVtype({vtype:"number",min:1,max:1024})):(c.speedLimitModel.uploadLimit.setTips("(1-"+o.currentUploadLimitMax+")"),c.speedLimitModel.uploadLimit.setVtype({vtype:"number",min:1,max:o.currentUploadLimitMax}))}}})}},function(i,n,a,s,l,o){var d=o.device.getNetworkMode();return d.unshift(c),{delayInterval:0,currentEnablePriority:!1,currentDownloadLimitMax:1e3,currentUploadLimitMax:1e3,speedLimitMaxRules:0,isTriband:o.device.getIsTriband(),supportWifi6E:o.device.getConfig().supportWifi6E,loadClientListStore:function(e,t){o.ajax.request({proxy:"connectedClientProxy",data:{operation:e},success:function(e){l.networkMap.trigger("ev_clients_number_changed",e.onlineClientNum),s.connectedClientsStore.loadData(e.clientList),i.updateClientFilter(e.clientNum),i.filterClients(),t&&t()},fail:t,error:t})},updateClientFilter:function(t){var e=d.map(function(e){return{name:u[e]["text"]+" ("+(t[e]||0)+")",value:e}});s.clientFilterOptions.loadItems(e),n.mapClientsView.clientFilterType.getValue()||n.mapClientsView.clientFilterType.setValue(c)},filterClients:function(t){var e;(t=t||n.mapClientsView.clientFilterType.getValue())!==c&&(e={func:function(e){return e.networkMode===t}}),s.connectedClientsStore.dom().triggerHandler("ev_grid_filter",[e,!1])},getClients:function(){i.getClientsInterval=o.timer.setInterval(i,function(){"clients"!=l.networkMap.getCurrentModule()||n.mapClientsView.clientNameMsg.viewObjs[0].settings.shown||n.mapClientsView.blockConfirmMsg.viewObjs[0].settings.shown||0<i.delayInterval||(s.onlineDeviceStore.load({url:p.su.url("/admin/access_control?form=black_devices")}),i.delayInterval=1,i.loadClientListStore("loadSpeed",function(){i.delayInterval=0}))},20011,!0)},getAccessControlMode:function(e){var t;e&&(t=e.success),s.onlineDeviceStore.load({url:p.su.url("/admin/access_control?form=black_devices")}),a.accessControlEnableM.load(),a.accessControl.load({success:function(e){t&&t(a.accessControl.getData())}})},setBlackMode:function(t){"off"==a.accessControlEnableM.enable.getValue()&&a.accessControlEnableM.load({data:{operation:"write",enable:"on"}}),a.accessControl.load({data:{operation:"write",access_mode:"black"},success:function(e){n.mapClientsView.mapClientsAccessControlBtn.setText(p.su.CHAR.NETWORK_MAP.VIEW_BLACKLIST),n.mapClientsView.blockConfirmMsg.setContent(p.su.CHAR.NETWORK_MAP.BLOCK_MSG_BLACKLIST),t&&t()}})},blockDevice:function(e){function t(){o.ajax.request({data:{operation:"block",data:JSON.stringify([e]),index:s.connectedClientsStore.getIndex(e.key),key:e.key},url:p.su.url("/admin/access_control?form=black_devices"),success:function(){s.onlineDeviceStore.load({url:p.su.url("/admin/access_control?form=black_devices"),success:function(){i.loadClientListStore("loadDevice")}})}})}"on"==a.accessControlEnableM.enable.getValue()&&"black"==a.accessControl.accessMode.getValue()?t():i.setBlackMode(t)},beforeDestroy:function(){clearInterval(null)},getIPaddr:function(e){if(deviceStatusData)for(var t in deviceStatusData)for(var i=0,n=deviceStatusData[t].length;i<n;i++)if(deviceStatusData[t][i].macaddr==e)return deviceStatusData[t][i].ipaddr||"";return""},getConnectType:function(e){if(deviceStatusData)for(var t in deviceStatusData)for(var i=0,n=deviceStatusData[t].length;i<n;i++)if(deviceStatusData[t][i].macaddr==e)return t;return""},checkDeviceName:function(e){return 0<e.length&&e.length<65&&o.vtype.validate(e,{vtype:"deviceName"})},convertSpeedVal:function(e,t){e=parseInt(e,10)*(t?1024:8);var i,t={};return t.speed=e,t.unit=p.su.CHAR.NETWORK_MAP.KBPS_BIT,0!==e&&(i=(e=e/1024)/1024,e<1?t.speed=e.toFixed(2):i<1?t.speed=e<1e3?e.toFixed(1):Math.floor(e):(t.speed=i.toFixed(1),t.unit=p.su.CHAR.NETWORK_MAP.MBPS_BIT)),t},convertSpeedLimitVal:function(e,t){var e=parseInt(e,10),i=e<1024?p.su.CHAR.NETWORK_MAP.KBPS_BIT:(e=(e/1024).toFixed(0),p.su.CHAR.NETWORK_MAP.MBPS_BIT);return{speed:e,unit:i}},convertRate:function(e){return e&&-1!==e?(e/=1e3).toFixed(10<e?0:1):"- -"},convertSignal:function(e){return!e||(e=Math.ceil((parseInt(e)+91)/10))<0?0:5<e?5:e},generateDeviceIcon:function(e){var t="",t=(t=(t+='<div class="device-type-container widget-container">')+('<span class="icon '+i.detectDeviceType(e.deviceType)+' ">')+('<span class="'+(e.speedLimitOnline?"online-tag":"offline-tag")+'"></span>'))+('<span class="guest-tag '+(e.isGuest?"":"hidden")+'"></span>')+"</span>";return null!=e.enableInternet&&(t+='<span class="text">'+(e.enableInternet?"":p.su.CHAR.NETWORK_MAP.INTERNET_PAUSED)+"</span>"),t+="</div>"},detectDeviceType:function(e){return"other"===(e=e.toLowerCase())?"icon-pc":"icon-"+e}}})}(jQuery);